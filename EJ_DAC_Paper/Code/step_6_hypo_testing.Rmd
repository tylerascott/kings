---
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Documents/WORK/kings")

library(dotenv)
library(tidyverse)
library(stargazer)
library(igraph)
library(migraph)
```

```{r, include=FALSE}

setwd("~/Documents/WORK/kings")
load_dot_env()

place_existance <- readRDS("EJ_DAC_Paper/Data/place_existance.RDS")
all_places <- bind_rows(place_existance)
network_fp <- paste0(Sys.getenv("BOX_PATH"), "/EJ_Paper/cleaned_extracts_DACified")
extract_list <- list.files(network_fp)

gsp_ids <- gsub("^0+", "", gsub("\\.RDS", "", extract_list))

all_nodes <- data.frame()

for (g in seq_along(gsp_ids)) {
   net <- readRDS(paste0(network_fp, "/", extract_list[g]))
   gsp_id <- paste0("gsp_",gsp_ids[g])
   
   nodes <- tibble(igraph::as_data_frame(net, what = "vertices"))
   suppressWarnings({
      nodes <- nodes %>% 
         mutate(across(any_of(c('deg', 'pr', 'pr_w', 'alpha', 'in', 'out', 'eig', 'gsp_id')),
                    as.numeric),
                gsp_id = as.numeric(gsp_id)) %>% 
         mutate(
            # pagerank for whole network
            pr_std = (pr - mean(pr, na.rm=TRUE)) / sd(pr, na.rm=TRUE) + 1,
            prw_std = (pr_w - mean(pr_w, na.rm=TRUE)) / sd(pr_w, na.rm=TRUE) + 1,
            
            leader_dist_min = ifelse(is.infinite(leader_dist_min), NA, leader_dist_min),
            MHI_std = MHI/10000,
            POP_std = POP/1000000,
            is_place = ifelse(is.na(GEOID20), 0, 1),
             ) 
      all_nodes <- rbind(all_nodes, nodes)
   })
}

all_place_nodes <- all_nodes %>% 
   filter(is_place == 1) 
```

```{r}

sub_all_nodes <- data.frame()

for (g in seq_along(gsp_ids)) {
   net <- readRDS(paste0(network_fp, "/", extract_list[g]))
   gsp_id <- paste0("gsp_",gsp_ids[g])

   subnet <- induced_subgraph(net, 
                              which(V(net)$admin_in > 0|
                                       V(net)$sust_criteria_in > 0| 
                                       V(net)$monitoring_networks_in > 0|
                                       V(net)$projects_mgmt_actions_in > 0))
   subnet <- set_vertex_attr(subnet,
                             's_pr',
                             value = igraph::page_rank(subnet,
                                                       weights = NA)$vector)  
   subnet <- set_vertex_attr(subnet,
                             's_pr_w',
                             value = igraph::page_rank(subnet,
                                                       weights = V(subnet)$weight)$vector)
   subnet <- set_vertex_attr(subnet,
                             's_alpha',
                             value = node_alpha(subnet))
   subnet <- set_vertex_attr(subnet,
                             's_in',
                             value = node_indegree(subnet))
   subnet <- set_vertex_attr(subnet,
                             's_out',
                             value = node_outdegree(subnet))
   subnet <- set_vertex_attr(subnet,
                             's_deg',
                             value = node_deg(subnet, direction = 'all'))
   subnet <- set_vertex_attr(subnet,
                             's_eig',
                             value = node_eigenvector(subnet))
   
   nodes <- tibble(igraph::as_data_frame(subnet, what = "vertices"))
   suppressWarnings({
      nodes <- nodes %>% 
         mutate(across(any_of(c('deg', 'pr', 'pr_w', 'alpha', 'in', 'out', 'eig', 'gsp_id')),
                    as.numeric),
                gsp_id = as.numeric(gsp_id)) %>% 
         mutate(
            # pagerank for whole network
            pr_std = (pr - mean(pr, na.rm=TRUE)) / sd(pr, na.rm=TRUE) + 1,
            prw_std = (pr_w - mean(pr_w, na.rm=TRUE)) / sd(pr_w, na.rm=TRUE) + 1,
            # pagerank for substnative subnet
            s_pr_std = (s_pr - mean(s_pr, na.rm=TRUE)) / sd(s_pr, na.rm=TRUE) + 1,
            s_prw_std = (s_pr_w - mean(s_pr_w, na.rm=TRUE)) / sd(s_pr_w, na.rm=TRUE) + 1,
             
            leader_dist_min = ifelse(is.infinite(leader_dist_min), NA, leader_dist_min),
            MHI_std = MHI/10000,
            POP_std = POP/1000000,
            is_place = ifelse(is.na(GEOID20), 0, 1),
             )
      sub_all_nodes <- rbind(sub_all_nodes, nodes)
   })
}

sub_all_place_nodes <- sub_all_nodes %>% 
   filter(is_place == 1)
   
```


###
### HYPOTHESIS 1a: DACs have lower existence than non-disadvantaged communities
###

```{r}
#cross-tab for (DAC, exists)
with(all_places, table(exists, DAC))

# glm for if DAC influences exists
exists_mod <- glm(exists~incorporated*DAC+POP+per_latino, 
                family = binomial,
                data = all_places)

exists_mod_2 <- glm(exists ~ MHI*incorporated+POP+per_latino, 
                  family = binomial,
                  data = all_places)

stargazer(exists_mod, exists_mod_2, type='text')

# stargazer(exists_mod, exists_mod_2, type='html', out = 'EJ_DAC_Paper/Out/mods/1a_exists_mod.html')
```


###
### HYPOTHESIS 1b: DACs have lower count within sections than non-disadvantaged communities
###

```{r, results='asis'}

f_dac <- glm(`in` ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)

g_dac <- glm(`in` ~ MHI_std+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)

a_dac <- glm(admin_in ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)


b_dac <- glm(basin_plan_in ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)

c_dac <- glm(sust_criteria_in ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)

d_dac <- glm(monitoring_networks_in ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)

e_dac <- glm(projects_mgmt_actions_in ~ DAC+
               POP_std+
               incorporated+
               per_latino,
             family=poisson,
              data = all_place_nodes)


stargazer(f_dac, g_dac, a_dac, b_dac, c_dac, d_dac, e_dac, type='text')

# stargazer(a_dac, b_dac, c_dac, d_dac, e_dac, type='html', out = 'EJ_DAC_Paper/Out/mods/1b_dac_locs_mod.html')

```

###
### HYPOTHESIS 2a: DACs have lower eigenvector centrality than non-disadvantaged communities
###
### HYPOTHESIS 2b: DACs have lower eigenvector centrality than non-disadvantaged communities in substantive sections
###



```{r, results='asis'}

eig_mod_3<- glm(prw_std ~ MHI_std+
                 POP_std+
                 incorporated+
                 per_latino,
               family= poisson,
              data = sub_all_place_nodes)

eig_mod_4 <- glm(prw_std ~ DAC+
                 POP_std+
                 incorporated+
                 per_latino,
               family= poisson,
              data = sub_all_place_nodes)

stargazer(eig_mod_3, eig_mod_4, type='text')

# stargazer(eig_mod_3, eig_mod_4, type='html',
#           out = 'EJ_DAC_Paper/Out/mods/2ab_eig_mod.html')
```


###
### HYPOTHESIS 3a: DACs have lower leader closeness than non-disadvantaged communities
###
### HYPOTHESIS 3b: DACs have lower leader closeness than non-disadvantaged communities in substantive sections
###

```{r, results='asis'}

# lead_mod <- glm(leader_dist_min ~ MHI_std+
#                  POP_std+
#                  incorporated+
#                  per_latino,
#                 family=poisson,
#               data = all_place_nodes)
# 
# 
# lead_mod_2 <- glm(leader_dist_min ~ DAC+
#                  per_latino+
#                  POP_std+
#                  incorporated,
#                  family=poisson,
#               data = all_place_nodes)

lead_mod_3 <- glm(leader_dist_min ~ MHI_std+
                 POP_std+
                 incorporated+
                 per_latino,
                family=poisson,
              data = sub_all_place_nodes)


lead_mod_4 <- glm(leader_dist_min ~ DAC+
                 per_latino+
                 POP_std+
                 incorporated,
                 family=poisson,
              data = sub_all_place_nodes)

stargazer(lead_mod_3, lead_mod_4, type='text')
          
# stargazer(lead_mod, lead_mod_2, lead_mod_3, lead_mod_4, type='text',
#           out = 'EJ_DAC_Paper/Out/mods/3ab_lead_mod.html')
```

###
### ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
### NOT CURRENTLY IN USE
###

```{r, results='asis'}

eig_a <- glm((eig_std) ~ admin_per,
               family= inverse.gaussian(link = "log"),
              data = all_nodes)


eig_b <- glm((eig_std) ~ basin_plan_per,
               family= inverse.gaussian(link = "log"),
              data = all_nodes)


eig_c <- glm((eig_std) ~ sust_criteria_per,
               family= inverse.gaussian(link = "log"),
              data = all_nodes)


eig_d <- glm((eig_std) ~ monitoring_networks_per,
               family= inverse.gaussian(link = "log"),
              data = all_nodes)


eig_e <- glm((eig_std) ~ projects_mgmt_actions_per,
               family= inverse.gaussian(link = "log"),
              data = all_nodes)

stargazer(eig_a, eig_b, eig_c, eig_d, eig_e, type='text')

# stargazer(eig_a, eig_b, eig_c, eig_d, eig_e, type='html', out = 'EJ_DAC_Paper/Out/mods/3_eig_locs_mod.html')
```


```{r, results='asis'}

lead_a <- glm(leader_dist_min ~ admin_per,
              family=poisson,
              data = all_nodes)


lead_b <- glm(leader_dist_min ~ basin_plan_per,
              family=poisson,
              data = all_nodes)


lead_c <- glm(leader_dist_min ~ sust_criteria_per,
              family=poisson,
              data = all_nodes)


lead_d <- glm(leader_dist_min ~ monitoring_networks_per,
              family=poisson,
              data = all_nodes)


lead_e <- glm(leader_dist_min ~ projects_mgmt_actions_per,
              family=poisson,
              data = all_nodes)

stargazer(lead_a, lead_b, lead_c, lead_d, lead_e, type='text')

# stargazer(lead_a, lead_b, lead_c, lead_d, lead_e, type='html', out = 'EJ_DAC_Paper/Out/mods/4_lead_locs_mod.html')

```

```{r, results='asis'}

a_dac <- glm(admin ~ is_place,
             family = poisson,
              data = all_nodes)


b_dac <- glm(basin_plan ~ is_place,
             family = poisson,
              data = all_nodes)

c_dac <- glm(sust_criteria ~ is_place,
             family = poisson,
              data = all_nodes)

d_dac <- glm(monitoring_networks ~ is_place,
             family = poisson,
              data = all_nodes)

e_dac <- glm(projects_mgmt_actions ~ is_place,
             family = poisson,
              data = all_nodes)

stargazer(a_dac, b_dac, c_dac, d_dac, e_dac, type='text')

# stargazer(a_dac, b_dac, c_dac, d_dac, e_dac, type='html', out = 'EJ_DAC_Paper/Out/mods/5_place_locs_mod.html')
```
